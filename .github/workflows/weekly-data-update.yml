name: Weekly Data Update & Integrity Check

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰1æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: "0 1 * * 1"
  workflow_dispatch:
    inputs:
      force_update:
        description: "å¼·åˆ¶æ›´æ–°ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãï¼‰"
        required: false
        default: false
        type: boolean
      repositories:
        description: "å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªï¼ˆJSONé…åˆ—å½¢å¼ï¼‰"
        required: false
        default: ""
        type: string
      check_integrity:
        description: "ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ"
        required: false
        default: true
        type: boolean
      run_mode:
        description: "å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰"
        required: false
        default: "update_and_check"
        type: choice
        options:
          - update_only
          - check_only
          - update_and_check
      debug_mode:
        description: "ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆè©³ç´°ãƒ­ã‚°å‡ºåŠ›ï¼‰"
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "20"
  # SLIç›®æ¨™å€¤
  MAX_EXECUTION_TIME_MINUTES: 30
  MAX_API_RESPONSE_TIME_SECONDS: 10
  MIN_SUCCESS_RATE_PERCENT: 95

jobs:
  data-update-and-check:
    runs-on: ubuntu-latest
    timeout-minutes: 35 # SREãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹: æ˜ç¤ºçš„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

    # ä¸¦è¡Œå®Ÿè¡Œåˆ¶å¾¡ï¼ˆåŒæ™‚å®Ÿè¡Œã‚’1ã¤ã«åˆ¶é™ï¼‰
    concurrency:
      group: weekly-data-update-${{ github.ref }}
      cancel-in-progress: false

    permissions:
      contents: write
      actions: read
      pull-requests: read
      issues: write
      repository-projects: read
      id-token: write # OIDCãƒˆãƒ¼ã‚¯ãƒ³ç”¨

    # ç’°å¢ƒå›ºæœ‰ã®è¨­å®š
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      - name: ğŸ“‹ Workflow Information
        run: |
          echo "::notice title=Workflow Start::Weekly Data Update & Integrity Check started"
          echo "ğŸš€ **Workflow Execution Details**"
          echo "- Repository: ${{ github.repository }}"
          echo "- Run ID: ${{ github.run_id }}"
          echo "- Actor: ${{ github.actor }}"
          echo "- Event: ${{ github.event_name }}"
          echo "- Ref: ${{ github.ref }}"
          echo "- SHA: ${{ github.sha }}"
          echo "- Run Mode: ${{ github.event.inputs.run_mode || 'update_and_check' }}"
          echo "- Debug Mode: ${{ github.event.inputs.debug_mode || 'false' }}"

          # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç”¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
          echo "WORKFLOW_START_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "::group::Environment Variables"
          env | grep -E '^(GITHUB_|RUNNER_)' | sort
          echo "::endgroup::"

      - name: ğŸ” Security Scan
        run: |
          echo "::group::Security Pre-checks"

          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œæ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "âœ… Scheduled execution - trusted trigger"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "âœ… Manual execution by: ${{ github.actor }}"
          else
            echo "âš ï¸ Unexpected trigger: ${{ github.event_name }}"
          fi

          # ãƒªãƒã‚¸ãƒˆãƒªå…¥åŠ›ã®åŸºæœ¬æ¤œè¨¼
          if [[ -n "${{ github.event.inputs.repositories }}" ]]; then
            echo "ğŸ“ Custom repositories specified - validating JSON format"
            echo '${{ github.event.inputs.repositories }}' | jq empty || {
              echo "::error::Invalid JSON format in repositories input"
              exit 1
            }
          fi

          echo "::endgroup::"

      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2 # å¤‰æ›´æ¤œçŸ¥ç”¨ã«éå»1ã‚³ãƒŸãƒƒãƒˆå–å¾—

      - name: ğŸ”§ Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: ğŸ“¦ Install Dependencies with Audit
        run: |
          echo "::group::Dependencies Installation"

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
          npm audit --audit-level=high || {
            echo "::warning::High severity vulnerabilities detected"
            npm audit fix --audit-level=high || echo "::warning::Some vulnerabilities could not be auto-fixed"
          }

          # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm ci --prefer-offline

          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã®æ¤œè¨¼
          echo "ğŸ“‹ Installed packages:"
          npm list --depth=0

          echo "::endgroup::"

      - name: ğŸ” Pre-execution Health Check
        id: health_check
        run: |
          echo "::group::System Health Check"

          # ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯
          echo "ğŸ’¾ System Resources:"
          echo "- Memory: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
          echo "- Disk: $(df -h / | tail -1 | awk '{print $3 "/" $2 " (" $5 " used)"}')"
          echo "- CPU: $(nproc) cores"

          # Node.jsç’°å¢ƒç¢ºèª
          echo "ğŸŸ¢ Node.js Environment:"
          echo "- Node.js: $(node --version)"
          echo "- npm: $(npm --version)"

          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ç¢ºèª
          echo "ğŸ“ Project Structure:"
          ls -la

          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
          required_files=("package.json" "next.config.ts" "scripts/common-utils.mjs" "scripts/update-weekly-data.mjs")
          missing_files=()

          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              missing_files+=("$file")
            fi
          done

          if [[ ${#missing_files[@]} -gt 0 ]]; then
            echo "::error::Missing required files: ${missing_files[*]}"
            exit 1
          fi

          echo "health_status=healthy" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: ğŸ“Š Pre-update Data Integrity Check
        id: pre_check
        if: github.event.inputs.check_integrity != 'false' && github.event.inputs.run_mode != 'update_only'
        timeout-minutes: 5
        run: |
          echo "::group::Pre-update Integrity Analysis"

          # å°‚ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
          cat > integrity-check.mjs << 'EOF'
          import { checkDataIntegrity } from './scripts/common-utils.mjs';

          try {
            console.log('ğŸ” Starting pre-update data integrity check...');
            const result = await checkDataIntegrity();
            
            console.log('ğŸ“‹ Pre-check Summary:');
            console.log(`- Total files: ${result.totalFiles}`);
            console.log(`- Valid files: ${result.validFiles}`);
            console.log(`- Issues found: ${result.issues.length}`);
            
            if (result.issues.length > 0) {
              console.log('âš ï¸ Issues detected:');
              result.issues.slice(0, 5).forEach((issue, i) => {
                console.log(`  ${i + 1}. ${issue}`);
              });
              
              if (result.issues.length > 5) {
                console.log(`  ... and ${result.issues.length - 5} more issues`);
              }
            } else {
              console.log('âœ… No integrity issues detected');
            }
            
            // GitHubç’°å¢ƒå¤‰æ•°ã«çµæœã‚’ä¿å­˜
            console.log(`::set-output name=issues_count::${result.issues.length}`);
            console.log(`::set-output name=total_files::${result.totalFiles}`);
            console.log(`::set-output name=valid_files::${result.validFiles}`);
            
          } catch (error) {
            console.error('âŒ Pre-check failed:', error);
            process.exit(1);
          }
          EOF

          node integrity-check.mjs
          rm integrity-check.mjs

          echo "::endgroup::"

      - name: ğŸ”§ Load Repository Configuration
        id: config
        run: |
          echo "::group::Repository Configuration"

          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‹•çš„ã«ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã‚’èª­ã¿è¾¼ã¿
          if [[ -n "${{ github.event.inputs.repositories }}" ]]; then
            echo "ğŸ“ Using custom repositories from input"
            echo "repositories_json=${{ github.event.inputs.repositories }}" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“‚ Loading default repositories from config"
            repositories_json=$(node scripts/config-loader.mjs json)
            echo "repositories_json=$repositories_json" >> $GITHUB_OUTPUT
          fi

          echo "ğŸ” Repository configuration loaded:"
          echo "$repositories_json" | jq '.'

          echo "::endgroup::"

      - name: ğŸ”„ Update Weekly Data
        id: data_update
        if: github.event.inputs.run_mode != 'check_only'
        timeout-minutes: 25
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          FORCE_UPDATE: ${{ github.event.inputs.force_update }}
          TARGET_REPOSITORIES: ${{ steps.config.outputs.repositories_json }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
        run: |
          echo "::group::Data Update Process"

          # é–‹å§‹æ™‚åˆ»è¨˜éŒ²
          echo "UPDATE_START_TIME=$(date +%s)" >> $GITHUB_ENV

          # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
          if [[ "$DEBUG_MODE" == "true" ]]; then
            export DEBUG=*
            echo "ğŸ› Debug mode enabled"
          fi

          # ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®å®Ÿè¡Œ
          echo "ğŸš€ Starting data update process..."

          if node scripts/update-weekly-data.mjs; then
            echo "update_status=success" >> $GITHUB_OUTPUT
            echo "::notice title=Data Update::Data update completed successfully"
          else
            echo "update_status=failed" >> $GITHUB_OUTPUT
            echo "::error title=Data Update Failed::Data update process failed"
            exit 1
          fi

          # å®Ÿè¡Œæ™‚é–“è¨ˆæ¸¬
          update_duration=$(($(date +%s) - $UPDATE_START_TIME))
          echo "update_duration=$update_duration" >> $GITHUB_OUTPUT
          echo "â±ï¸ Update duration: ${update_duration}s"

          echo "::endgroup::"

      - name: ğŸ“ Detect Data Changes
        id: changes
        if: github.event.inputs.run_mode != 'check_only'
        run: |
          echo "::group::Change Detection"

          git add data/

          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --cached --quiet; then
            echo "ğŸ“Š No data changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changed_files=0" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“Š Data changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            changed_files=$(git diff --cached --name-only data/ | wc -l)
            echo "changed_files=$changed_files" >> $GITHUB_OUTPUT
            echo "ğŸ“ Changed files: $changed_files"
            
            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            echo "ğŸ“‹ Changed files list:"
            git diff --cached --name-only data/ | head -20
            
            if [[ $changed_files -gt 20 ]]; then
              echo "... and $((changed_files - 20)) more files"
            fi
          fi

          echo "::endgroup::"

      - name: ğŸ“¤ Commit and Push Changes
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.run_mode != 'check_only'
        timeout-minutes: 3
        run: |
          echo "::group::Git Operations"

          # Gitè¨­å®š
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
          week_number=$(date -u '+%Y-W%V')
          commit_message="chore: é€±æ¬¡ãƒ‡ãƒ¼ã‚¿æ›´æ–° $week_number

          - å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.changes.outputs.changed_files }}
          - å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.run_mode || 'update_and_check' }}
          - å®Ÿè¡Œè€…: ${{ github.actor }}
          - å®Ÿè¡ŒID: ${{ github.run_id }}"

          # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
          git commit -m "$commit_message"

          # ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
          max_retries=3
          retry_count=0

          while [[ $retry_count -lt $max_retries ]]; do
            if git push; then
              echo "âœ… Changes pushed successfully"
              break
            else
              retry_count=$((retry_count + 1))
              echo "âš ï¸ Push failed (attempt $retry_count/$max_retries)"
              if [[ $retry_count -lt $max_retries ]]; then
                echo "ğŸ”„ Retrying in 10 seconds..."
                sleep 10
                git pull --rebase
              else
                echo "::error::Failed to push after $max_retries attempts"
                exit 1
              fi
            fi
          done

          echo "::endgroup::"

      - name: ğŸ” Post-update Comprehensive Check
        id: post_check
        if: github.event.inputs.check_integrity != 'false' && github.event.inputs.run_mode != 'update_only'
        timeout-minutes: 10
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Post-update Validation"

          # å°‚ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§åŒ…æ‹¬çš„ãƒã‚§ãƒƒã‚¯
          cat > post-check.mjs << 'EOF'
          import { 
            checkDataIntegrity, 
            testApiEndpoints, 
            startServer, 
            waitForServer, 
            stopServer, 
            setupProcessHandlers 
          } from './scripts/common-utils.mjs';
          import { execSync } from 'child_process';

          let serverProcess = null;
          let checkResults = {
            integrity: null,
            apiTest: false,
            serverStarted: false,
            errors: []
          };

          try {
            console.log('ğŸš€ Starting comprehensive post-update check...');
            
            // ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
            console.log('ğŸ“¦ Building application...');
            execSync('npm run build', { stdio: 'inherit' });
            
            // ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
            console.log('ğŸŒ Starting server for API validation...');
            serverProcess = await startServer();
            setupProcessHandlers(serverProcess);
            checkResults.serverStarted = true;
            
            // ã‚µãƒ¼ãƒãƒ¼å¿œç­”å¾…æ©Ÿï¼ˆæ”¹å–„ã•ã‚ŒãŸã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
            await waitForServer(15);
            
            // ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±å–å¾—
            const repoResponse = await fetch('http://localhost:3000/api/repositories');
            if (!repoResponse.ok) {
              throw new Error(`Repository API failed: ${repoResponse.status}`);
            }
            const repoData = await repoResponse.json();
            console.log(`ğŸ“Š Found ${repoData.repositories?.length || 0} repositories`);
            
            // APIãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            checkResults.apiTest = await testApiEndpoints(repoData.repositories || []);
            console.log(`ğŸ§ª API test result: ${checkResults.apiTest ? 'PASS' : 'FAIL'}`);
            
            // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
            checkResults.integrity = await checkDataIntegrity();
            console.log(`ğŸ” Integrity check: ${checkResults.integrity.validFiles}/${checkResults.integrity.totalFiles} files valid`);
            
            // çµæœã®ä¿å­˜
            const fs = await import('fs');
            const report = {
              timestamp: new Date().toISOString(),
              workflow: {
                runId: process.env.GITHUB_RUN_ID,
                actor: process.env.GITHUB_ACTOR,
                event: process.env.GITHUB_EVENT_NAME
              },
              checks: {
                apiTest: checkResults.apiTest,
                integrity: {
                  totalFiles: checkResults.integrity.totalFiles,
                  validFiles: checkResults.integrity.validFiles,
                  issuesCount: checkResults.integrity.issues.length,
                  issues: checkResults.integrity.issues.slice(0, 10)
                }
              },
              summary: {
                overallStatus: checkResults.apiTest && checkResults.integrity.issues.length === 0 ? 'PASS' : 'FAIL',
                criticalIssues: checkResults.integrity.issues.length,
                apiWorking: checkResults.apiTest
              }
            };
            
            fs.writeFileSync('integrity-report.json', JSON.stringify(report, null, 2));
            
            // çµæœåˆ¤å®š
            if (checkResults.integrity.issues.length > 0) {
              console.log(`âŒ Data integrity issues detected: ${checkResults.integrity.issues.length}`);
              console.log('::error title=Data Integrity Issues::Critical data integrity issues found');
              process.exit(1);
            } else if (!checkResults.apiTest) {
              console.log('âŒ API functionality test failed');
              console.log('::error title=API Test Failed::API functionality validation failed');
              process.exit(1);
            } else {
              console.log('âœ… All post-update checks passed');
              console.log('::notice title=Validation Success::All integrity and functionality checks passed');
            }
            
          } catch (error) {
            checkResults.errors.push(error.message);
            console.error('âŒ Post-update check failed:', error);
            console.log(`::error title=Post-update Check Failed::${error.message}`);
            process.exit(1);
          } finally {
            if (serverProcess) {
              stopServer(serverProcess);
            }
          }
          EOF

          node post-check.mjs
          rm post-check.mjs

          echo "::endgroup::"

      - name: ğŸ“ˆ Generate Comprehensive Report
        id: report
        if: always()
        timeout-minutes: 2
        run: |
          echo "::group::Report Generation"

          # å®Ÿè¡Œæ™‚é–“è¨ˆç®—
          total_duration=$(($(date +%s) - $WORKFLOW_START_TIME))

          # SLIè¨ˆç®—
          sli_execution_time=$([[ $total_duration -le $((MAX_EXECUTION_TIME_MINUTES * 60)) ]] && echo "PASS" || echo "FAIL")

          # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          cat > update-summary.md << EOF
          # ğŸ“Š Weekly Data Update Report

          **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
          **Run ID:** [\`${{ github.run_id }}\`](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})  
          **Actor:** ${{ github.actor }}  
          **Event:** ${{ github.event_name }}

          ## ğŸ¯ Execution Summary

          | Metric | Value | Status |
          |--------|-------|--------|
          | Run Mode | ${{ github.event.inputs.run_mode || 'update_and_check' }} | â„¹ï¸ |
          | Force Update | ${{ github.event.inputs.force_update || 'false' }} | â„¹ï¸ |
          | Total Duration | ${total_duration}s | $sli_execution_time |
          | Health Check | ${{ steps.health_check.outputs.health_status || 'unknown' }} | $([[ "${{ steps.health_check.outputs.health_status }}" == "healthy" ]] && echo "âœ…" || echo "âŒ") |
          | Data Update | ${{ steps.data_update.outputs.update_status || 'skipped' }} | $([[ "${{ steps.data_update.outputs.update_status }}" == "success" ]] && echo "âœ…" || echo "âŒ") |
          | Changes Detected | ${{ steps.changes.outputs.has_changes || 'false' }} | â„¹ï¸ |
          | Files Changed | ${{ steps.changes.outputs.changed_files || '0' }} | â„¹ï¸ |

          ## ğŸ“Š Data Analysis

          EOF

          # ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã®è©³ç´°
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            cat >> update-summary.md << EOF
          ### âœ… Data Updates

          - **New data was collected and committed**
          - **Changed Files:** ${{ steps.changes.outputs.changed_files }}
          - **Update Duration:** ${{ steps.data_update.outputs.update_duration || 'N/A' }}s

          EOF
          else
            cat >> update-summary.md << EOF
          ### â„¹ï¸ No Data Changes

          All data was already up to date. No new information was collected.

          EOF
          fi

          # æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯çµæœ
          if [[ -f "integrity-report.json" ]]; then
            issues_count=$(jq -r '.checks.integrity.issuesCount // 0' integrity-report.json)
            total_files=$(jq -r '.checks.integrity.totalFiles // 0' integrity-report.json)
            valid_files=$(jq -r '.checks.integrity.validFiles // 0' integrity-report.json)
            api_working=$(jq -r '.checks.apiTest // false' integrity-report.json)
            
            cat >> update-summary.md << EOF
          ### ğŸ” Integrity & Functionality Check

          | Check Type | Result | Details |
          |------------|--------|---------|
          | API Functionality | $([[ "$api_working" == "true" ]] && echo "âœ… PASS" || echo "âŒ FAIL") | All endpoints responding |
          | Data Files | $valid_files/$total_files valid | $([[ $issues_count -eq 0 ]] && echo "âœ… No issues" || echo "âš ï¸ $issues_count issues") |
          | Overall Status | $([[ "$api_working" == "true" && $issues_count -eq 0 ]] && echo "âœ… HEALTHY" || echo "âŒ ISSUES DETECTED") | System operational status |

          EOF
            
            if [[ $issues_count -gt 0 ]]; then
              cat >> update-summary.md << EOF
          #### ğŸš¨ Issues Detected

          \`\`\`
          $(jq -r '.checks.integrity.issues[]' integrity-report.json | head -10)
          \`\`\`

          EOF
              
              if [[ $issues_count -gt 10 ]]; then
                echo "_... and $((issues_count - 10)) more issues_" >> update-summary.md
              fi
            fi
          fi

          # SLI/SLOæƒ…å ±
          cat >> update-summary.md << EOF
          ## ğŸ“ˆ Service Level Indicators (SLI)

          | SLI | Target | Actual | Status |
          |-----|--------|--------|--------|
          | Execution Time | â‰¤ ${{ env.MAX_EXECUTION_TIME_MINUTES }}m | $(($total_duration / 60))m $(($total_duration % 60))s | $sli_execution_time |
          | Success Rate | â‰¥ ${{ env.MIN_SUCCESS_RATE_PERCENT }}% | $([[ "${{ job.status }}" == "success" ]] && echo "100%" || echo "0%") | $([[ "${{ job.status }}" == "success" ]] && echo "âœ…" || echo "âŒ") |

          ---

          > ğŸ¤– This report was automatically generated by GitHub Actions  
          > ğŸ“… Next scheduled run: $(date -d 'next monday 01:00 UTC' -u '+%Y-%m-%d %H:%M UTC')
          EOF

          # ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
          cat update-summary.md

          echo "::endgroup::"
          echo "report_generated=true" >> $GITHUB_OUTPUT

      - name: ğŸš¨ Handle Critical Failures
        if: failure()
        timeout-minutes: 2
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã®èª­ã¿è¾¼ã¿
            let reportContent = 'Weekly data update process failed without detailed report.';
            let issueLabels = ['bug', 'data-update', 'automation', 'sre-alert'];
            let issuePriority = 'P2';

            try {
              if (fs.existsSync('update-summary.md')) {
                reportContent = fs.readFileSync('update-summary.md', 'utf8');
              } else if (fs.existsSync('integrity-report.json')) {
                const report = JSON.parse(fs.readFileSync('integrity-report.json', 'utf8'));
                const issuesCount = report.checks?.integrity?.issuesCount || 0;
                
                if (issuesCount > 0) {
                  issuePriority = 'P1';
                  issueLabels.push('data-corruption');
                }
                
                reportContent = `## Data Integrity Alert
                
                **Issues Detected:** ${issuesCount}
                **API Status:** ${report.checks?.apiTest ? 'Working' : 'Failed'}
                
                ### Details
                \`\`\`json
                ${JSON.stringify(report.checks?.integrity?.issues?.slice(0, 5) || [], null, 2)}
                \`\`\``;
              }
            } catch (error) {
              console.log('Could not read report files:', error);
            }

            // éšœå®³ã®é‡è¦åº¦åˆ¤å®š
            const jobStatus = '${{ job.status }}';
            const stepStatuses = {
              health_check: '${{ steps.health_check.outcome }}',
              data_update: '${{ steps.data_update.outcome }}',
              post_check: '${{ steps.post_check.outcome }}'
            };

            // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªéšœå®³ã‹ã©ã†ã‹ã®åˆ¤å®š
            const isCritical = stepStatuses.health_check === 'failure' || 
                              (stepStatuses.data_update === 'failure' && stepStatuses.post_check === 'failure');

            if (isCritical) {
              issuePriority = 'P0';
              issueLabels.push('critical', 'incident');
            }

            const issueTitle = `ğŸš¨ [${issuePriority}] Weekly Data Update Failed - ${new Date().toISOString().split('T')[0]}`;

            const issueBody = `## ${isCritical ? 'ğŸ”¥ CRITICAL' : 'âš ï¸'} Weekly Data Update Failure

            ${reportContent}

            ## ğŸ” Failure Analysis

            **Job Status:** ${jobStatus}
            **Step Results:**
            - Health Check: ${stepStatuses.health_check}
            - Data Update: ${stepStatuses.data_update}
            - Post-update Check: ${stepStatuses.post_check}

            ## ğŸ“‹ Incident Details

            - **Priority:** ${issuePriority}
            - **Timestamp:** ${new Date().toISOString()}
            - **Actor:** ${{ github.actor }}
            - **Run ID:** [${context.runId}](${runUrl})
            - **Repository:** ${context.repo.owner}/${context.repo.repo}

            ## ğŸ”§ Next Steps

            ${isCritical ? 
              '1. **IMMEDIATE ACTION REQUIRED** - Check system health\n2. Investigate root cause\n3. Consider manual data collection\n4. Update monitoring alerts' :
              '1. Review workflow logs\n2. Check for temporary issues\n3. Re-run if needed\n4. Monitor next scheduled run'
            }

            ---

            > ğŸ¤– Auto-generated by SRE monitoring system`;

            // Issueä½œæˆ
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: issueLabels
            });

            console.log(`Created ${isCritical ? 'CRITICAL' : 'standard'} incident issue with priority ${issuePriority}`);

      - name: ğŸ“¤ Upload Artifacts & Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-update-reports-${{ github.run_id }}
          path: |
            update-summary.md
            integrity-report.json
            *.log
          retention-days: 90 # SREãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹: é•·æœŸä¿å­˜

      - name: ğŸ“Š Final Metrics & Summary
        if: always()
        run: |
          echo "::group::Execution Metrics"

          # æœ€çµ‚ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨ˆç®—
          total_duration=$(($(date +%s) - $WORKFLOW_START_TIME))

          echo "ğŸ¯ **Final Execution Summary**"
          echo "- Total Duration: ${total_duration}s"
          echo "- Job Status: ${{ job.status }}"
          echo "- Run ID: ${{ github.run_id }}"
          echo "- Files Changed: ${{ steps.changes.outputs.changed_files || '0' }}"

          # æˆåŠŸ/å¤±æ•—ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… Weekly data update completed successfully"
            echo "::notice title=Success::Weekly data update and integrity check completed successfully in ${total_duration}s"
          else
            echo "âŒ Weekly data update failed"
            echo "::error title=Failure::Weekly data update process failed after ${total_duration}s"
          fi

          echo "::endgroup::"
