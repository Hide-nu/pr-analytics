name: PR Data Validation

on:
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".gitignore"
      - ".github/workflows/**" # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤‰æ›´ã§ã¯å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
  push:
    branches: [main, develop]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".gitignore"
      - ".github/workflows/**"

env:
  NODE_VERSION: "20"
  # PRç”¨ã®åˆ¶é™å€¤ï¼ˆæœ¬ç•ªã‚ˆã‚Šå³ã—ãï¼‰
  MAX_PR_VALIDATION_TIME_MINUTES: 15
  MAX_SERVER_START_TIME_SECONDS: 30

jobs:
  # è»½é‡ãƒã‚§ãƒƒã‚¯ã‚’ã¾ãšå®Ÿè¡Œï¼ˆé«˜é€Ÿãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
  quick-validation:
    name: âš¡ Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      has-code-changes: ${{ steps.changes.outputs.has-code-changes }}
      has-data-changes: ${{ steps.changes.outputs.has-data-changes }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Detect Changes
        id: changes
        run: |
          echo "::group::Change Analysis"

          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†æ
          changed_files=$(git diff --name-only HEAD~1..HEAD)

          code_changes=$(echo "$changed_files" | grep -E '\.(ts|tsx|js|jsx|mjs)$' | wc -l)
          data_changes=$(echo "$changed_files" | grep -E '^data/' | wc -l)
          config_changes=$(echo "$changed_files" | grep -E '\.(json|yml|yaml)$' | wc -l)

          echo "ğŸ“Š Change Summary:"
          echo "- Code files: $code_changes"
          echo "- Data files: $data_changes"
          echo "- Config files: $config_changes"

          # GitHub outputsã«è¨­å®š
          echo "has-code-changes=$([[ $code_changes -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has-data-changes=$([[ $data_changes -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      - name: ğŸ”’ Security Quick Scan
        run: |
          echo "::group::Security Pre-checks"

          # åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
          if git diff --name-only HEAD~1..HEAD | grep -E '\.(env|key|pem|p12)$'; then
            echo "::error::Potential secret files detected"
            exit 1
          fi

          # å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
          if git diff --name-only HEAD~1..HEAD | xargs -I {} sh -c 'test -f "{}" && test $(stat -c%s "{}") -gt 10485760' 2>/dev/null; then
            echo "::warning::Large files detected (>10MB)"
          fi

          echo "::endgroup::"

  # ãƒ¡ã‚¤ãƒ³ã®æ¤œè¨¼ã‚¸ãƒ§ãƒ–ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  validate:
    name: ğŸ§ª Full Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quick-validation

    # ä¸¦è¡Œå®Ÿè¡Œåˆ¶å¾¡
    concurrency:
      group: pr-validation-${{ github.event.pull_request.number || github.sha }}
      cancel-in-progress: true

    permissions:
      contents: read
      actions: read
      pull-requests: write # ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã®ãŸã‚
      repository-projects: read
      checks: write
      security-events: write

    strategy:
      fail-fast: false # 1ã¤å¤±æ•—ã—ã¦ã‚‚ä»–ã‚’ç¶šè¡Œ
      matrix:
        validation-type: [code-quality, functionality, data-integrity]

    steps:
      - name: ğŸ“‹ Validation Start
        run: |
          echo "::notice title=Validation::Starting ${{ matrix.validation-type }} validation"
          echo "ğŸš€ **Validation Details**"
          echo "- Type: ${{ matrix.validation-type }}"
          echo "- PR: #${{ github.event.pull_request.number || 'N/A' }}"
          echo "- SHA: ${{ github.sha }}"
          echo "- Actor: ${{ github.actor }}"

          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è¨˜éŒ²
          echo "VALIDATION_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # PRã«ã¯æ·±ã„å±¥æ­´ä¸è¦

      - name: ğŸ”§ Setup Node.js Environment
        if: matrix.validation-type != 'data-integrity' || needs.quick-validation.outputs.has-code-changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: ğŸ“¦ Install Dependencies
        if: matrix.validation-type != 'data-integrity' || needs.quick-validation.outputs.has-code-changes == 'true'
        run: |
          echo "::group::Dependencies"

          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡å‘ä¸Šã®ãŸã‚ä¸¦åˆ—å®Ÿè¡Œ
          npm ci --prefer-offline --no-audit --progress=false

          echo "::endgroup::"

      # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
      - name: ğŸ” Code Quality Checks
        if: matrix.validation-type == 'code-quality'
        run: |
          echo "::group::Code Quality Analysis"

          # ä¸¦åˆ—å®Ÿè¡Œã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
          (
            echo "ğŸ”¤ TypeScript Check..."
            npx tsc --noEmit --incremental
          ) &

          (
            echo "ğŸ“ ESLint Check..."
            npm run lint
          ) &

          (
            echo "ğŸ§ª Unit Tests..."
            npm run test:run
          ) &

          # ã™ã¹ã¦ã®ã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…æ©Ÿ
          wait

          echo "âœ… All code quality checks passed"
          echo "::endgroup::"

      # æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
      - name: ğŸ”§ Load Repository Configuration
        id: config
        if: matrix.validation-type == 'functionality'
        run: |
          echo "::group::Repository Configuration"

          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã‚’èª­ã¿è¾¼ã¿
          repositories_json=$(node scripts/config-loader.mjs json)
          echo "repositories_json=$repositories_json" >> $GITHUB_OUTPUT

          echo "ğŸ” Using repository configuration:"
          echo "$repositories_json" | jq '.'

          echo "::endgroup::"

      - name: ğŸš€ Functionality Validation
        if: matrix.validation-type == 'functionality'
        timeout-minutes: 10
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          TARGET_REPOSITORIES: ${{ steps.config.outputs.repositories_json }}
        run: |
          echo "::group::Build & Functionality Test"

          # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          echo "ğŸ—ï¸ Building application..."
          npm run build

          # æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
          cat > functionality-test.mjs << 'EOF'
          import { 
            checkEnvironment, 
            startServer, 
            waitForServer, 
            stopServer, 
            testApiEndpoints,
            setupProcessHandlers 
          } from './scripts/common-utils.mjs';

          let serverProcess = null;
          const testResults = {
            environment: false,
            serverStart: false,
            apiTest: false,
            duration: 0
          };

          const startTime = Date.now();

          try {
            // ç’°å¢ƒãƒã‚§ãƒƒã‚¯
            console.log('ğŸ”§ Environment check...');
            checkEnvironment();
            testResults.environment = true;
            
            // ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆPRç”¨ã¯çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
            console.log('ğŸŒ Starting server...');
            serverProcess = await startServer();
            setupProcessHandlers(serverProcess);
            testResults.serverStart = true;
            
            // ã‚µãƒ¼ãƒãƒ¼å¿œç­”å¾…æ©Ÿ
            await waitForServer(parseInt(process.env.MAX_SERVER_START_TIME_SECONDS) || 30);
            
            // åŸºæœ¬çš„ãªAPIãƒ†ã‚¹ãƒˆ
            const repositories = JSON.parse(process.env.TARGET_REPOSITORIES || '[]');
            console.log('ğŸ§ª API functionality test...');
            testResults.apiTest = await testApiEndpoints(repositories);
            
            testResults.duration = Date.now() - startTime;
            
            // çµæœã®ä¿å­˜
            const fs = await import('fs');
            const report = {
              timestamp: new Date().toISOString(),
              testResults,
              performance: {
                duration: testResults.duration,
                withinSLA: testResults.duration < (parseInt(process.env.MAX_PR_VALIDATION_TIME_MINUTES) * 60 * 1000)
              }
            };
            
            fs.writeFileSync('functionality-report.json', JSON.stringify(report, null, 2));
            
            if (!testResults.apiTest) {
              throw new Error('API functionality test failed');
            }
            
            console.log(`âœ… All functionality tests passed in ${testResults.duration}ms`);
            
          } catch (error) {
            console.error('âŒ Functionality test failed:', error);
            process.exit(1);
          } finally {
            if (serverProcess) {
              stopServer(serverProcess);
            }
          }
          EOF

          node functionality-test.mjs
          rm functionality-test.mjs

          echo "::endgroup::"

      # ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      - name: ğŸ” Data Integrity Check
        if: matrix.validation-type == 'data-integrity'
        timeout-minutes: 5
        run: |
          echo "::group::Data Integrity Analysis"

          # ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§å°‚ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
          cat > data-integrity-test.mjs << 'EOF'
          import { checkDataIntegrity } from './scripts/common-utils.mjs';

          try {
            console.log('ğŸ” Data integrity analysis...');
            const result = await checkDataIntegrity();
            
            console.log('ğŸ“Š Data Integrity Summary:');
            console.log(`- Total files: ${result.totalFiles}`);
            console.log(`- Valid files: ${result.validFiles}`);
            console.log(`- Issues: ${result.issues.length}`);
            
            // çµæœã®ä¿å­˜
            const fs = await import('fs');
            const report = {
              timestamp: new Date().toISOString(),
              integrity: {
                totalFiles: result.totalFiles,
                validFiles: result.validFiles,
                issuesCount: result.issues.length,
                issues: result.issues.slice(0, 5),  // æœ€åˆã®5ä»¶ã®ã¿
                healthStatus: result.issues.length === 0 ? 'HEALTHY' : 'ISSUES_DETECTED'
              }
            };
            
            fs.writeFileSync('data-integrity-report.json', JSON.stringify(report, null, 2));
            
            if (result.issues.length > 0) {
              console.log('âš ï¸ Data integrity issues detected:');
              result.issues.slice(0, 3).forEach((issue, i) => {
                console.log(`  ${i + 1}. ${issue}`);
              });
              
              if (result.issues.length > 3) {
                console.log(`  ... and ${result.issues.length - 3} more issues`);
              }
            } else {
              console.log('âœ… Data integrity check passed');
            }
            
          } catch (error) {
            console.error('âŒ Data integrity check failed:', error);
            process.exit(1);
          }
          EOF

          node data-integrity-test.mjs
          rm data-integrity-test.mjs

          echo "::endgroup::"

      - name: ğŸ“Š Validation Metrics
        if: always()
        run: |
          echo "::group::Metrics Collection"

          validation_duration=$(($(date +%s) - $VALIDATION_START_TIME))

          echo "ğŸ“ˆ ${{ matrix.validation-type }} Validation Metrics:"
          echo "- Duration: ${validation_duration}s"
          echo "- Status: ${{ job.status }}"
          echo "- Max allowed: ${{ env.MAX_PR_VALIDATION_TIME_MINUTES }}m"

          # SLAéµå®ˆãƒã‚§ãƒƒã‚¯
          max_seconds=$((MAX_PR_VALIDATION_TIME_MINUTES * 60))
          if [[ $validation_duration -le $max_seconds ]]; then
            echo "âœ… SLA met (â‰¤${max_seconds}s)"
          else
            echo "âš ï¸ SLA exceeded (>${max_seconds}s)"
          fi

          echo "::endgroup::"

      - name: ğŸ“¤ Upload Validation Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-${{ matrix.validation-type }}-${{ github.run_id }}
          path: |
            *-report.json
            *.log
          retention-days: 30

  # çµæœã®é›†ç´„ã¨PRã‚³ãƒ¡ãƒ³ãƒˆ
  aggregate-results:
    name: ğŸ“‹ Aggregate Results
    runs-on: ubuntu-latest
    needs: [quick-validation, validate]
    if: always() && github.event_name == 'pull_request'
    timeout-minutes: 3

    permissions:
      pull-requests: write

    steps:
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ğŸ“Š Aggregate Validation Results
        id: aggregate
        run: |
          echo "::group::Results Aggregation"

          # çµæœã®é›†ç´„
          declare -A results
          results[code-quality]="unknown"
          results[functionality]="unknown"
          results[data-integrity]="unknown"

          # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰çµæœã‚’èª­ã¿å–ã‚Š
          for type in code-quality functionality data-integrity; do
            if [[ -f "artifacts/validation-${type}-${{ github.run_id }}/${type}-report.json" ]]; then
              results[$type]="success"
            elif [[ -f "artifacts/validation-${type}-${{ github.run_id }}/functionality-report.json" ]]; then
              results[$type]="success"
            elif [[ -f "artifacts/validation-${type}-${{ github.run_id }}/data-integrity-report.json" ]]; then
              results[$type]="success"
            else
              results[$type]="failed"
            fi
          done

          # ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰åˆ¤å®š
          code_quality_status="${{ needs.validate.result }}"
          if [[ "$code_quality_status" == "success" ]]; then
            results[code-quality]="success"
          elif [[ "$code_quality_status" == "failure" ]]; then
            results[code-quality]="failed"
          fi

          # å…¨ä½“ã®æˆåŠŸ/å¤±æ•—åˆ¤å®š
          overall_success=true
          for result in "${results[@]}"; do
            if [[ "$result" == "failed" ]]; then
              overall_success=false
              break
            fi
          done

          echo "overall_success=$overall_success" >> $GITHUB_OUTPUT
          echo "code_quality=${results[code-quality]}" >> $GITHUB_OUTPUT
          echo "functionality=${results[functionality]}" >> $GITHUB_OUTPUT
          echo "data_integrity=${results[data-integrity]}" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ Aggregation Summary:"
          echo "- Code Quality: ${results[code-quality]}"
          echo "- Functionality: ${results[functionality]}"
          echo "- Data Integrity: ${results[data-integrity]}"
          echo "- Overall: $overall_success"

          echo "::endgroup::"

      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const { owner, repo, number } = context.issue;
            const runId = context.runId;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;

            const overall = '${{ steps.aggregate.outputs.overall_success }}' === 'true';
            const codeQuality = '${{ steps.aggregate.outputs.code_quality }}';
            const functionality = '${{ steps.aggregate.outputs.functionality }}';
            const dataIntegrity = '${{ steps.aggregate.outputs.data_integrity }}';

            const statusIcon = overall ? 'âœ…' : 'âŒ';
            const statusText = overall ? 'æˆåŠŸ' : 'å¤±æ•—';

            const getStatusEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failed': return 'âŒ';
                default: return 'â³';
              }
            };

            // è©³ç´°æƒ…å ±ã®åé›†
            let performanceInfo = '';
            let integrityInfo = '';

            try {
              // æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã®æ€§èƒ½æƒ…å ±
              if (fs.existsSync('artifacts/validation-functionality-' + runId + '/functionality-report.json')) {
                const funcReport = JSON.parse(
                  fs.readFileSync('artifacts/validation-functionality-' + runId + '/functionality-report.json', 'utf8')
                );
                const duration = Math.round(funcReport.testResults.duration / 1000);
                const slaStatus = funcReport.performance.withinSLA ? 'âœ…' : 'âš ï¸';
                performanceInfo = `**æ€§èƒ½:** ${duration}s ${slaStatus}`;
              }
              
              // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§æƒ…å ±
              if (fs.existsSync('artifacts/validation-data-integrity-' + runId + '/data-integrity-report.json')) {
                const integrityReport = JSON.parse(
                  fs.readFileSync('artifacts/validation-data-integrity-' + runId + '/data-integrity-report.json', 'utf8')
                );
                const issues = integrityReport.integrity.issuesCount;
                const status = issues === 0 ? 'å¥å…¨' : `${issues}ä»¶ã®å•é¡Œ`;
                integrityInfo = `**ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§:** ${status}`;
              }
            } catch (error) {
              console.log('Could not read detailed reports:', error.message);
            }

            const body = `## ${statusIcon} PRæ¤œè¨¼çµæœ: ${statusText}

            ã“ã®PRã«å¯¾ã™ã‚‹åŒ…æ‹¬çš„ãªæ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚

            ### ğŸ“Š æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼

            | æ¤œè¨¼é …ç›® | çµæœ | è©³ç´° |
            |----------|------|------|
            | ${getStatusEmoji(codeQuality)} **ã‚³ãƒ¼ãƒ‰å“è³ª** | ${codeQuality === 'success' ? 'PASS' : 'FAIL'} | TypeScriptå‹ãƒã‚§ãƒƒã‚¯ãƒ»ESLintãƒ»å˜ä½“ãƒ†ã‚¹ãƒˆ |
            | ${getStatusEmoji(functionality)} **æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ** | ${functionality === 'success' ? 'PASS' : 'FAIL'} | APIå‹•ä½œç¢ºèªãƒ»ãƒ“ãƒ«ãƒ‰æ¤œè¨¼ |
            | ${getStatusEmoji(dataIntegrity)} **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§** | ${dataIntegrity === 'success' ? 'PASS' : 'FAIL'} | ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ãƒ»å†…å®¹æ¤œè¨¼ |

            ### ğŸ“ˆ æ€§èƒ½ãƒ»å“è³ªæŒ‡æ¨™

            ${performanceInfo}  
            ${integrityInfo}

            ### ğŸ” å¤‰æ›´å†…å®¹åˆ†æ

            - **ã‚³ãƒ¼ãƒ‰å¤‰æ›´:** ${{ needs.quick-validation.outputs.has-code-changes === 'true' ? 'ã‚ã‚Š' : 'ãªã—' }}
            - **ãƒ‡ãƒ¼ã‚¿å¤‰æ›´:** ${{ needs.quick-validation.outputs.has-data-changes === 'true' ? 'ã‚ã‚Š' : 'ãªã—' }}

            ${overall ? 
              '### âœ… æ‰¿èªæ¨å¥¨\n\nã™ã¹ã¦ã®æ¤œè¨¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚ã“ã®PRã¯ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™ã€‚' :
              '### âš ï¸ ä¿®æ­£ãŒå¿…è¦\n\nä¸€éƒ¨ã®æ¤œè¨¼ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚'
            }

            ---

            ğŸ“‹ **è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ:** [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœ](${runUrl})  
            ğŸ¤– **è‡ªå‹•ç”Ÿæˆ:** SREå“è³ªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 
            `;

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã—ã¦æ›´æ–° or æ–°è¦ä½œæˆ
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: number
            });

            const existingComment = comments.data.find(
              comment => comment.user.login === 'github-actions[bot]' && 
                         comment.body.includes('PRæ¤œè¨¼çµæœ')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existingComment.id,
                body
              });
              console.log('Updated existing PR comment');
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: number,
                body
              });
              console.log('Created new PR comment');
            }

      - name: ğŸš¨ Handle Critical Failures
        if: failure() || (steps.aggregate.outputs.overall_success == 'false' && github.event_name == 'push')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // pushã‚¤ãƒ™ãƒ³ãƒˆã§ã®å¤±æ•—æ™‚ã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆ
            if (context.eventName === 'push') {
              const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ [P1] ${context.ref.split('/').pop()}ãƒ–ãƒ©ãƒ³ãƒã®æ¤œè¨¼å¤±æ•—`,
                body: `## é‡è¦ãƒ–ãƒ©ãƒ³ãƒã§ã®æ¤œè¨¼å¤±æ•—
                
                **ãƒ–ãƒ©ãƒ³ãƒ:** ${context.ref}
                **ã‚³ãƒŸãƒƒãƒˆ:** ${context.sha}
                **å®Ÿè¡Œè€…:** ${context.actor}
                **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—:** ${new Date().toISOString()}
                
                ### å¤±æ•—ã—ãŸæ¤œè¨¼
                
                - ã‚³ãƒ¼ãƒ‰å“è³ª: ${{ steps.aggregate.outputs.code_quality }}
                - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ: ${{ steps.aggregate.outputs.functionality }}
                - ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: ${{ steps.aggregate.outputs.data_integrity }}
                
                ### å¯¾å¿œãŒå¿…è¦
                
                1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœã‚’ç¢ºèª
                2. å¤±æ•—åŸå› ã‚’ç‰¹å®šãƒ»ä¿®æ­£
                3. å¿…è¦ã«å¿œã˜ã¦ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹ä½œæˆ
                
                **è©³ç´°:** [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ](${runUrl})
                `,
                labels: ['bug', 'ci-failure', 'priority-high', 'sre-alert']
              });
            }

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆç‹¬ç«‹å®Ÿè¡Œï¼‰
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 5

    permissions:
      security-events: write
      contents: read

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Dependency Security Scan
        run: |
          echo "::group::Security Analysis"

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ï¼ˆé«˜åº¦ãªãƒã‚§ãƒƒã‚¯ï¼‰
          npm audit --audit-level=moderate --json > audit-results.json || true

          # çµæœã®åˆ†æ
          if [[ -s audit-results.json ]]; then
            echo "ğŸ” Security vulnerabilities detected:"
            cat audit-results.json | jq -r '.vulnerabilities | to_entries[] | "- \(.key): \(.value.severity)"' | head -10
            
            # é‡å¤§åº¦åˆ¤å®š
            critical_count=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
            high_count=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
            
            if [[ $critical_count -gt 0 || $high_count -gt 0 ]]; then
              echo "::error::Critical or high severity vulnerabilities found"
              echo "::warning::Consider running 'npm audit fix' to resolve issues"
            fi
          else
            echo "âœ… No security vulnerabilities detected"
          fi

          echo "::endgroup::"
